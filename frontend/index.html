<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bera - WhatsApp Style Messaging</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Helvetica, Arial, sans-serif;
        }

        :root {
            --wa-green: #008069;
            --wa-green-dark: #005c4b;
            --wa-teal-green: #00a884;
            --wa-chat-bg: #efeae2;
            --wa-dark-bg: #202c33;
            --wa-outgoing-msg: #d9fdd3;
            --wa-incoming-msg: #ffffff;
            --wa-text-primary: #3b4a54;
            --wa-text-secondary: #667781;
            --wa-icon-color: #8696a0;
            --wa-border-color: #e9edef;
            --wa-online: #00a884;
            --wa-offline: #8696a0;
            --wa-hover-bg: #f5f5f5;
            --wa-active-bg: #e9edef;
            --wa-notification: #f15c6d;
        }

        body {
            background: linear-gradient(135deg, var(--wa-teal-green), var(--wa-green));
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .app-container {
            width: 100%;
            max-width: 1400px;
            height: 97vh;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: 30%;
            min-width: 380px;
            background: white;
            border-right: 1px solid var(--wa-border-color);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .sidebar-header {
            padding: 10px 16px;
            background: var(--wa-active-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--wa-border-color);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            background: var(--wa-green);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            cursor: pointer;
        }

        .avatar-small {
            width: 35px;
            height: 35px;
            font-size: 16px;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 500;
            font-size: 16px;
            color: var(--wa-text-primary);
        }

        .user-status {
            font-size: 13px;
            color: var(--wa-text-secondary);
        }

        .header-icons {
            display: flex;
            gap: 20px;
            color: var(--wa-icon-color);
        }

        .header-icons i {
            cursor: pointer;
            font-size: 18px;
        }

        .search-container {
            padding: 8px 14px;
            background: white;
            border-bottom: 1px solid var(--wa-border-color);
        }

        .search-box {
            background: var(--wa-hover-bg);
            border-radius: 18px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-box i {
            color: var(--wa-text-secondary);
            font-size: 14px;
        }

        .search-box input {
            background: transparent;
            border: none;
            color: var(--wa-text-primary);
            width: 100%;
            font-size: 14px;
            outline: none;
        }

        .search-results {
            position: absolute;
            background: white;
            width: calc(30% - 28px);
            max-height: 300px;
            overflow-y: auto;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 10;
            margin-top: 5px;
            border: 1px solid var(--wa-border-color);
        }

        .chats-list {
            flex: 1;
            overflow-y: auto;
            background: white;
        }

        .chat-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid var(--wa-border-color);
        }

        .chat-item:hover {
            background: var(--wa-hover-bg);
        }

        .chat-item.active {
            background: var(--wa-active-bg);
        }

        .chat-info {
            flex: 1;
            margin-left: 15px;
        }

        .chat-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .chat-name {
            font-weight: 500;
            font-size: 16px;
            color: var(--wa-text-primary);
        }

        .chat-time {
            font-size: 12px;
            color: var(--wa-text-secondary);
        }

        .chat-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-last-msg {
            font-size: 14px;
            color: var(--wa-text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        .chat-status {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .unread-count {
            background: var(--wa-green);
            color: white;
            font-size: 12px;
            padding: 0 6px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }

        /* Main Chat Area */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            background: var(--wa-chat-bg);
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d4d4d4' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .chat-header {
            padding: 10px 16px;
            background: var(--wa-active-bg);
            border-bottom: 1px solid var(--wa-border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .current-chat-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .current-chat-details {
            display: flex;
            flex-direction: column;
        }

        .current-chat-name {
            font-weight: 500;
            font-size: 16px;
            color: var(--wa-text-primary);
        }

        .current-chat-status {
            font-size: 13px;
            color: var(--wa-text-secondary);
        }

        .chat-actions {
            display: flex;
            gap: 20px;
            color: var(--wa-icon-color);
        }

        .chat-actions i {
            cursor: pointer;
            font-size: 18px;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .message {
            max-width: 65%;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 4px;
            position: relative;
            display: flex;
            flex-direction: column;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .message.sent {
            align-self: flex-end;
            background: var(--wa-outgoing-msg);
            border-top-right-radius: 0;
        }

        .message.received {
            align-self: flex-start;
            background: var(--wa-incoming-msg);
            border-top-left-radius: 0;
        }

        .message-content {
            font-size: 15px;
            line-height: 1.4;
            word-wrap: break-word;
            color: var(--wa-text-primary);
        }

        .message-sender {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--wa-green);
        }

        .message-time {
            font-size: 11px;
            color: var(--wa-text-secondary);
            align-self: flex-end;
            margin-top: 4px;
        }

        .chat-input-container {
            padding: 10px 16px;
            background: var(--wa-active-bg);
            border-top: 1px solid var(--wa-border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-actions {
            display: flex;
            gap: 15px;
            color: var(--wa-icon-color);
        }

        .input-actions i {
            cursor: pointer;
            font-size: 18px;
        }

        .message-input {
            flex: 1;
            background: white;
            border: none;
            border-radius: 20px;
            padding: 12px 16px;
            color: var(--wa-text-primary);
            font-size: 15px;
            outline: none;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .send-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--wa-green);
            color: white;
            border: none;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        /* Auth Screen */
        .auth-container {
            display: flex;
            width: 100%;
            height: 100%;
            background: white;
        }

        .auth-left {
            flex: 1;
            background: linear-gradient(135deg, var(--wa-teal-green), var(--wa-green));
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            position: relative;
            overflow: hidden;
        }

        .auth-right {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            background: white;
        }

        .auth-form {
            width: 100%;
            max-width: 400px;
        }

        .auth-form h2 {
            margin-bottom: 30px;
            color: var(--wa-text-primary);
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--wa-text-primary);
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            background: white;
            border: 1px solid var(--wa-border-color);
            border-radius: 5px;
            font-size: 16px;
            color: var(--wa-text-primary);
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            border-color: var(--wa-green);
            outline: none;
        }

        .btn {
            padding: 15px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--wa-green);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--wa-green-dark);
        }

        .auth-switch {
            margin-top: 20px;
            text-align: center;
            color: var(--wa-text-secondary);
        }

        .auth-switch a {
            color: var(--wa-green);
            text-decoration: none;
            font-weight: 600;
        }

        /* Welcome Screen */
        .welcome-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            text-align: center;
            color: var(--wa-text-secondary);
            background: var(--wa-chat-bg);
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d4d4d4' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .welcome-icon {
            font-size: 120px;
            color: var(--wa-green);
            margin-bottom: 20px;
        }

        .welcome-title {
            font-size: 32px;
            color: var(--wa-text-primary);
            margin-bottom: 15px;
        }

        .welcome-text {
            font-size: 16px;
            max-width: 500px;
            line-height: 1.5;
        }

        /* Public Chat Room */
        .public-chat-item {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }

        .public-chat-item .chat-name {
            color: #2196f3;
        }

        .public-message .message-sender {
            color: #2196f3;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .sidebar {
                width: 40%;
                min-width: 300px;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                height: 100vh;
                border-radius: 0;
            }
            
            .auth-container {
                flex-direction: column;
            }
            
            .auth-left {
                padding: 20px;
            }
        }

        /* Loading and Error States */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--wa-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            color: #f44336;
            padding: 10px;
            text-align: center;
            background: rgba(244, 67, 54, 0.1);
            border-radius: 5px;
            margin: 10px 0;
        }

        .hidden {
            display: none;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            position: absolute;
            bottom: 0;
            right: 0;
        }

        .online {
            background: var(--wa-online);
        }

        .offline {
            background: var(--wa-offline);
        }

        .notification-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--wa-notification);
            position: absolute;
            top: -2px;
            right: -2px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Authentication Screen -->
        <div class="auth-container" id="authScreen">
            <div class="auth-left">
                <div class="welcome-screen">
                    <div class="welcome-icon">
                        <i class="fas fa-comments"></i>
                    </div>
                    <h1 class="welcome-title">Welcome to Bera</h1>
                    <p class="welcome-text">Simple, secure messaging for everyone. Connect with your friends and family in real-time with our easy-to-use platform.</p>
                </div>
            </div>
            <div class="auth-right">
                <div class="auth-form" id="loginForm">
                    <h2>Login to Your Account</h2>
                    <div id="loginError" class="error hidden"></div>
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password">
                    </div>
                    <button class="btn btn-primary" onclick="login()">Login</button>
                    <div class="auth-switch">
                        Don't have an account? <a href="#" onclick="showRegisterForm()">Register</a>
                    </div>
                </div>
                
                <div class="auth-form" id="registerForm" style="display: none;">
                    <h2>Create an Account</h2>
                    <div id="registerError" class="error hidden"></div>
                    <div class="form-group">
                        <label for="registerName">Username</label>
                        <input type="text" id="registerName" placeholder="Choose a username">
                    </div>
                    <div class="form-group">
                        <label for="registerEmail">Email</label>
                        <input type="email" id="registerEmail" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">Password</label>
                        <input type="password" id="registerPassword" placeholder="Create a password">
                    </div>
                    <button class="btn btn-primary" onclick="register()">Register</button>
                    <div class="auth-switch">
                        Already have an account? <a href="#" onclick="showLoginForm()">Login</a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main App Screen -->
        <div class="app-container" id="appScreen" style="display: none;">
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="user-info">
                        <div class="avatar" id="userAvatar">U</div>
                        <div class="user-details">
                            <div class="user-name" id="userName">User</div>
                            <div class="user-status">Online</div>
                        </div>
                    </div>
                    <div class="header-icons">
                        <i class="fas fa-status"></i>
                        <i class="fas fa-comment-alt"></i>
                        <i class="fas fa-ellipsis-v"></i>
                    </div>
                </div>
                
                <div class="search-container">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Search or start new chat" oninput="searchUsers()">
                    </div>
                    <div id="searchResults" class="search-results hidden"></div>
                </div>
                
                <div class="chats-list" id="friendsList">
                    <div class="chat-item public-chat-item" id="publicChatItem">
                        <div class="avatar avatar-small" style="background: #2196f3;">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="chat-info">
                            <div class="chat-top">
                                <div class="chat-name">Public Chat Room</div>
                                <div class="chat-time">Now</div>
                            </div>
                            <div class="chat-bottom">
                                <div class="chat-last-msg">Chat with everyone</div>
                                <div class="chat-status"></div>
                            </div>
                        </div>
                    </div>
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
            
            <div class="chat-container" id="chatContainer">
                <div class="welcome-screen" id="welcomeScreen">
                    <div class="welcome-icon">
                        <i class="fas fa-comment-slash"></i>
                    </div>
                    <h1 class="welcome-title">Your Messages</h1>
                    <p class="welcome-text">Select a chat from the sidebar or search for users to start messaging</p>
                </div>
                
                <div class="chat-header hidden" id="chatHeader">
                    <div class="current-chat-info">
                        <div class="avatar avatar-small" id="currentChatAvatar">F</div>
                        <div class="current-chat-details">
                            <div class="current-chat-name" id="currentChatName">Friend Name</div>
                            <div class="current-chat-status" id="currentChatStatus">Online</div>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <i class="fas fa-search"></i>
                        <i class="fas fa-paperclip"></i>
                        <i class="fas fa-ellipsis-v"></i>
                    </div>
                </div>
                
                <div class="chat-messages hidden" id="chatMessages">
                    <!-- Messages will be displayed here -->
                </div>
                
                <div class="chat-input-container hidden" id="chatInputContainer">
                    <div class="input-actions">
                        <i class="far fa-smile"></i>
                        <i class="fas fa-paperclip"></i>
                    </div>
                    <input type="text" class="message-input" id="messageInput" placeholder="Type a message" disabled>
                    <button class="send-button" id="sendButton" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API base URL - will be the same as the current domain in production
        const API_BASE = window.location.origin + '/api';
        let socket = null;
        let currentUser = null;
        let currentChatFriend = null;
        let friends = [];
        let friendRequests = [];
        let allUsers = [];
        let isPublicChat = false;

        // DOM Elements
        const authScreen = document.getElementById('authScreen');
        const appScreen = document.getElementById('appScreen');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const loginError = document.getElementById('loginError');
        const registerError = document.getElementById('registerError');
        const friendsList = document.getElementById('friendsList');
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const chatHeader = document.getElementById('chatHeader');
        const chatContainer = document.getElementById('chatContainer');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const chatInputContainer = document.getElementById('chatInputContainer');
        const currentChatAvatar = document.getElementById('currentChatAvatar');
        const currentChatName = document.getElementById('currentChatName');
        const currentChatStatus = document.getElementById('currentChatStatus');
        const publicChatItem = document.getElementById('publicChatItem');

        // Form switching
        function showRegisterForm() {
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
            loginError.classList.add('hidden');
        }

        function showLoginForm() {
            registerForm.style.display = 'none';
            loginForm.style.display = 'block';
            registerError.classList.add('hidden');
        }

        // Authentication functions
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showError(loginError, 'Please fill in all fields');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Save token and user data
                    localStorage.setItem('beraToken', data.token);
                    localStorage.setItem('beraUser', JSON.stringify(data.user));
                    
                    // Initialize app
                    initApp(data.user, data.token);
                } else {
                    showError(loginError, data.error || 'Login failed');
                }
            } catch (error) {
                showError(loginError, 'Network error. Please try again.');
            }
        }

        async function register() {
            const username = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            if (!username || !email || !password) {
                showError(registerError, 'Please fill in all fields');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Save token and user data
                    localStorage.setItem('beraToken', data.token);
                    localStorage.setItem('beraUser', JSON.stringify(data.user));
                    
                    // Initialize app
                    initApp(data.user, data.token);
                } else {
                    showError(registerError, data.error || 'Registration failed');
                }
            } catch (error) {
                showError(registerError, 'Network error. Please try again.');
            }
        }

        function logout() {
            if (socket) {
                socket.disconnect();
            }
            
            localStorage.removeItem('beraToken');
            localStorage.removeItem('beraUser');
            
            appScreen.style.display = 'none';
            authScreen.style.display = 'flex';
            
            // Reset forms
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('registerName').value = '';
            document.getElementById('registerEmail').value = '';
            document.getElementById('registerPassword').value = '';
            
            loginError.classList.add('hidden');
            registerError.classList.add('hidden');
            
            showLoginForm();
        }

        // Initialize the app
        function initApp(user, token) {
            currentUser = user;
            
            // Update UI
            userAvatar.textContent = user.username.charAt(0).toUpperCase();
            userName.textContent = user.username;
            
            // Switch to app screen
            authScreen.style.display = 'none';
            appScreen.style.display = 'flex';
            
            // Connect to Socket.IO
            socket = io();
            
            // Authenticate socket
            socket.emit('authenticate', token);
            
            // Set up socket event listeners
            socket.on('newMessage', handleNewMessage);
            socket.on('messageSent', handleMessageSent);
            socket.on('userOnline', handleUserOnline);
            socket.on('userOffline', handleUserOffline);
            socket.on('friendRequest', handleFriendRequest);
            socket.on('friendRequestAccepted', handleFriendRequestAccepted);
            socket.on('typing', handleTyping);
            socket.on('error', handleError);
            socket.on('publicMessage', handlePublicMessage);
            
            // Load friends and messages
            loadFriends();
            loadAllUsers();
            
            // Set up message sending
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            sendButton.addEventListener('click', sendMessage);
            
            // Set up public chat room click
            publicChatItem.addEventListener('click', () => {
                document.querySelectorAll('.chat-item').forEach(f => f.classList.remove('active'));
                publicChatItem.classList.add('active');
                loadPublicChat();
            });
        }

        // Load friends list
        async function loadFriends() {
            try {
                const token = localStorage.getItem('beraToken');
                const response = await fetch(`${API_BASE}/friends`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    friends = await response.json();
                    renderFriendsList();
                } else {
                    console.error('Failed to load friends');
                }
            } catch (error) {
                console.error('Error loading friends:', error);
            }
        }

        // Load all users for search
        async function loadAllUsers() {
            try {
                const token = localStorage.getItem('beraToken');
                const response = await fetch(`${API_BASE}/users/search?q=`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    allUsers = await response.json();
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Render friends list
        function renderFriendsList() {
            if (friends.length === 0) {
                friendsList.innerHTML = `
                    <div class="chat-item public-chat-item" id="publicChatItem">
                        <div class="avatar avatar-small" style="background: #2196f3;">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="chat-info">
                            <div class="chat-top">
                                <div class="chat-name">Public Chat Room</div>
                                <div class="chat-time">Now</div>
                            </div>
                            <div class="chat-bottom">
                                <div class="chat-last-msg">Chat with everyone</div>
                                <div class="chat-status"></div>
                            </div>
                        </div>
                    </div>
                    <div class="chat-item"><div class="chat-info"><div class="chat-name">No friends yet</div><div class="chat-last-msg">Search for users to add friends</div></div></div>`;
                
                // Re-add event listener for public chat
                document.getElementById('publicChatItem').addEventListener('click', () => {
                    document.querySelectorAll('.chat-item').forEach(f => f.classList.remove('active'));
                    document.getElementById('publicChatItem').classList.add('active');
                    loadPublicChat();
                });
                
                return;
            }
            
            let friendsHTML = `
                <div class="chat-item public-chat-item" id="publicChatItem">
                    <div class="avatar avatar-small" style="background: #2196f3;">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="chat-info">
                        <div class="chat-top">
                            <div class="chat-name">Public Chat Room</div>
                            <div class="chat-time">Now</div>
                        </div>
                        <div class="chat-bottom">
                            <div class="chat-last-msg">Chat with everyone</div>
                            <div class="chat-status"></div>
                        </div>
                    </div>
                </div>`;
            
            friends.forEach(friend => {
                friendsHTML += `
                    <div class="chat-item" data-id="${friend._id}">
                        <div class="avatar avatar-small">
                            ${friend.username.charAt(0).toUpperCase()}
                            <span class="status-indicator ${friend.online ? 'online' : 'offline'}"></span>
                        </div>
                        <div class="chat-info">
                            <div class="chat-top">
                                <div class="chat-name">${friend.username}</div>
                                <div class="chat-time">${formatTime(friend.lastSeen)}</div>
                            </div>
                            <div class="chat-bottom">
                                <div class="chat-last-msg">Tap to start chatting</div>
                                <div class="chat-status"></div>
                            </div>
                        </div>
                    </div>`;
            });
            
            friendsList.innerHTML = friendsHTML;
            
            // Add event listeners to chat items
            document.querySelectorAll('.chat-item').forEach(item => {
                if (item.id !== 'publicChatItem') {
                    const friendId = item.dataset.id;
                    const friend = friends.find(f => f._id === friendId);
                    
                    item.addEventListener('click', () => {
                        document.querySelectorAll('.chat-item').forEach(f => f.classList.remove('active'));
                        item.classList.add('active');
                        loadChat(friend);
                    });
                }
            });
            
            // Re-add event listener for public chat
            document.getElementById('publicChatItem').addEventListener('click', () => {
                document.querySelectorAll('.chat-item').forEach(f => f.classList.remove('active'));
                document.getElementById('publicChatItem').classList.add('active');
                loadPublicChat();
            });
        }

        // Format time for display
        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Search users
        async function searchUsers() {
            const query = searchInput.value.trim();
            
            if (query.length < 1) {
                searchResults.classList.add('hidden');
                return;
            }
            
            try {
                const token = localStorage.getItem('beraToken');
                const response = await fetch(`${API_BASE}/users/search?q=${encodeURIComponent(query)}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const users = await response.json();
                    renderSearchResults(users);
                }
            } catch (error) {
                console.error('Error searching users:', error);
                // Fallback to client-side search if API fails
                const filteredUsers = allUsers.filter(user => 
                    user.username.toLowerCase().includes(query.toLowerCase())
                );
                renderSearchResults(filteredUsers);
            }
        }

        // Render search results
        function renderSearchResults(users) {
            if (users.length === 0) {
                searchResults.innerHTML = '<div class="chat-item"><div class="chat-name">No users found</div></div>';
                searchResults.classList.remove('hidden');
                return;
            }
            
            searchResults.innerHTML = '';
            
            users.forEach(user => {
                // Don't show current user in search results
                if (user._id === currentUser.id) return;
                
                const resultElement = document.createElement('div');
                resultElement.className = 'chat-item';
                
                // Check if already friends
                const isFriend = friends.some(friend => friend._id === user._id);
                
                resultElement.innerHTML = `
                    <div class="avatar avatar-small">
                        ${user.username.charAt(0).toUpperCase()}
                        <span class="status-indicator ${user.online ? 'online' : 'offline'}"></span>
                    </div>
                    <div class="chat-info">
                        <div class="chat-top">
                            <div class="chat-name">${user.username}</div>
                        </div>
                        <div class="chat-bottom">
                            <div class="chat-last-msg">${isFriend ? 'Already friends' : 'Click to add friend'}</div>
                            <div class="chat-status">
                                ${!isFriend ? `<button class="unread-count" onclick="sendFriendRequest('${user._id}')">Add</button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                // Add click handler to start chatting if already friends
                if (isFriend) {
                    resultElement.addEventListener('click', () => {
                        document.querySelectorAll('.chat-item').forEach(f => f.classList.remove('active'));
                        resultElement.classList.add('active');
                        loadChat(user);
                        searchResults.classList.add('hidden');
                        searchInput.value = '';
                    });
                }
                
                searchResults.appendChild(resultElement);
            });
            
            searchResults.classList.remove('hidden');
        }

        // Hide search results when clicking outside
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.classList.add('hidden');
            }
        });

        // Send friend request
        async function sendFriendRequest(userId) {
            try {
                const token = localStorage.getItem('beraToken');
                const response = await fetch(`${API_BASE}/friend-request/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    alert('Friend request sent!');
                    searchResults.classList.add('hidden');
                    searchInput.value = '';
                } else {
                    const data = await response.json();
                    alert(data.error || 'Failed to send friend request');
                }
            } catch (error) {
                console.error('Error sending friend request:', error);
            }
        }

        // Load chat with a friend
        async function loadChat(friend) {
            currentChatFriend = friend;
            isPublicChat = false;
            
            // Update chat header
            currentChatAvatar.textContent = friend.username.charAt(0).toUpperCase();
            currentChatName.textContent = friend.username;
            currentChatStatus.textContent = friend.online ? 'Online' : 'Offline';
            
            // Show chat interface, hide welcome screen
            welcomeScreen.classList.add('hidden');
            chatHeader.classList.remove('hidden');
            chatMessages.classList.remove('hidden');
            chatInputContainer.classList.remove('hidden');
            
            // Enable message input
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.placeholder = "Type a message";
            messageInput.focus();
            
            // Load messages
            try {
                const token = localStorage.getItem('beraToken');
                const response = await fetch(`${API_BASE}/messages/${friend._id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const messages = await response.json();
                    renderMessages(messages);
                } else {
                    chatMessages.innerHTML = '<div class="error">Failed to load messages</div>';
                }
            } catch (error) {
                console.error('Error loading messages:', error);
                chatMessages.innerHTML = '<div class="error">Error loading messages</div>';
            }
        }

        // Load public chat
        function loadPublicChat() {
            isPublicChat = true;
            currentChatFriend = null;
            
            // Update chat header
            currentChatAvatar.innerHTML = '<i class="fas fa-users"></i>';
            currentChatAvatar.style.background = '#2196f3';
            currentChatName.textContent = 'Public Chat Room';
            currentChatStatus.textContent = 'Online';
            
            // Show chat interface, hide welcome screen
            welcomeScreen.classList.add('hidden');
            chatHeader.classList.remove('hidden');
            chatMessages.classList.remove('hidden');
            chatInputContainer.classList.remove('hidden');
            
            // Enable message input
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.placeholder = "Type a message to everyone";
            messageInput.focus();
            
            // Clear messages and show welcome message
            chatMessages.innerHTML = `
                <div class="message received public-message">
                    <div class="message-sender">System</div>
                    <div class="message-content">Welcome to the public chat room! Everyone can see your messages here.</div>
                    <div class="message-time">Just now</div>
                </div>
            `;
        }

        // Render messages
        function renderMessages(messages) {
            if (messages.length === 0) {
                chatMessages.innerHTML = '<div class="message-info">No messages yet. Start the conversation!</div>';
                return;
            }
            
            chatMessages.innerHTML = '';
            
            messages.forEach(message => {
                const isSent = message.sender._id === currentUser.id;
                const messageElement = document.createElement('div');
                messageElement.className = `message ${isSent ? 'sent' : 'received'}`;
                
                const time = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                messageElement.innerHTML = `
                    <div class="message-content">${message.content}</div>
                    <div class="message-time">${time}</div>
                `;
                
                chatMessages.appendChild(messageElement);
            });
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Send message
        function sendMessage() {
            const content = messageInput.value.trim();
            
            if (!content) return;
            
            // Immediately show the message in the UI for better user experience
            const tempId = Date.now();
            if (isPublicChat) {
                // Show public message immediately
                const messageElement = document.createElement('div');
                messageElement.className = 'message sent';
                messageElement.id = 'temp-' + tempId;
                
                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                messageElement.innerHTML = `
                    <div class="message-content">${content}</div>
                    <div class="message-time">${time}</div>
                `;
                
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Send public message
                socket.emit('sendPublicMessage', {
                    content,
                    sender: {
                        id: currentUser.id,
                        username: currentUser.username
                    }
                });
            } else if (currentChatFriend) {
                // Show private message immediately
                const messageElement = document.createElement('div');
                messageElement.className = 'message sent';
                messageElement.id = 'temp-' + tempId;
                
                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                messageElement.innerHTML = `
                    <div class="message-content">${content}</div>
                    <div class="message-time">${time}</div>
                `;
                
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Send private message
                socket.emit('sendMessage', {
                    receiverId: currentChatFriend._id,
                    content
                });
            }
            
            // Clear input
            messageInput.value = '';
        }

        // Handle new message from socket
        function handleNewMessage(message) {
            // Only add if it's from the current chat friend
            if (message.sender._id === currentChatFriend?._id && !isPublicChat) {
                const messageElement = document.createElement('div');
                messageElement.className = 'message received';
                
                const time = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                messageElement.innerHTML = `
                    <div class="message-content">${message.content}</div>
                    <div class="message-time">${time}</div>
                `;
                
                chatMessages.appendChild(messageElement);
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        // Handle public message from socket
        function handlePublicMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message received public-message';
            
            const time = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageElement.innerHTML = `
                <div class="message-sender">${message.sender.username}</div>
                <div class="message-content">${message.content}</div>
                <div class="message-time">${time}</div>
            `;
            
            chatMessages.appendChild(messageElement);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Handle message sent confirmation
        function handleMessageSent(message) {
            // Remove the temporary message and replace with the confirmed one
            const tempMessages = document.querySelectorAll('[id^="temp-"]');
            if (tempMessages.length > 0) {
                tempMessages[tempMessages.length - 1].remove();
            }
            
            const messageElement = document.createElement('div');
            messageElement.className = 'message sent';
            
            const time = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageElement.innerHTML = `
                <div class="message-content">${message.content}</div>
                <div class="message-time">${time}</div>
            `;
            
            chatMessages.appendChild(messageElement);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Handle user online event
        function handleUserOnline(data) {
            const friendElement = document.querySelector(`.chat-item[data-id="${data.userId}"]`);
            if (friendElement) {
                const statusElement = friendElement.querySelector('.status-indicator');
                statusElement.className = 'status-indicator online';
                
                // If this is the current chat friend, update header
                if (currentChatFriend && currentChatFriend._id === data.userId) {
                    currentChatStatus.textContent = 'Online';
                }
            }
        }

        // Handle user offline event
        function handleUserOffline(data) {
            const friendElement = document.querySelector(`.chat-item[data-id="${data.userId}"]`);
            if (friendElement) {
                const statusElement = friendElement.querySelector('.status-indicator');
                statusElement.className = 'status-indicator offline';
                
                // If this is the current chat friend, update header
                if (currentChatFriend && currentChatFriend._id === data.userId) {
                    currentChatStatus.textContent = 'Offline';
                }
            }
        }

        // Handle new friend request
        function handleFriendRequest(data) {
            // Show notification
            alert(`New friend request from ${data.from.username}`);
            
            // Reload friends list to see the new request
            loadFriends();
        }

        // Handle friend request accepted
        function handleFriendRequestAccepted(data) {
            // Reload friends list
            loadFriends();
            
            // Show notification
            alert(`${data.by.username} accepted your friend request!`);
        }

        // Handle typing indicator
        function handleTyping(data) {
            // You could implement a typing indicator in the UI
            console.log(`User ${data.userId} is ${data.isTyping ? 'typing' : 'not typing'}`);
        }

        // Handle errors from socket
        function handleError(data) {
            console.error('Socket error:', data.message);
            alert('Error: ' + data.message);
        }

        // Utility function to show errors
        function showError(element, message) {
            element.textContent = message;
            element.classList.remove('hidden');
        }

        // Check if user is already logged in
        window.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('beraToken');
            const userData = localStorage.getItem('beraUser');
            
            if (token && userData) {
                const user = JSON.parse(userData);
                initApp(user, token);
            }
        });
    </script>
</body>
</html>
